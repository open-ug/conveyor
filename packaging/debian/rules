#!/usr/bin/make -f

%:
	dh $@

override_dh_auto_build:
	# Determine version: prefer $VERSION (CI), else fallback to changelog.
	VERSION=$${VERSION:-$$(dpkg-parsechangelog --show-field Version)}
	# strip Debian revision suffix (e.g. 1.2.3-1 -> 1.2.3)
	VERSION=$${VERSION%%-*}
	echo "Building conveyor with Version=$$VERSION (GOARCH=$$GOARCH)"

	# ensure package temp bin dir exists
	mkdir -p debian/tmp/usr/bin

	# build and place binary into debian/tmp so dh_install picks it up
	GO111MODULE=on CGO_ENABLED=0 \
	  go build -ldflags "-X github.com/open-ug/conveyor/cmd/cli.Version=$$VERSION -s -w" \
	  -o debian/tmp/usr/bin/conveyor ./cmd/conveyor

override_dh_auto_install:
	# dh_auto_install will install files from debian/tmp into package
	dh_auto_install