name: Release Conveyor (Debian Package)

on:
  release:
    types: [published]

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        goarch: [amd64]

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: "1.23.5"

      - name: Install build dependencies
        run: |
          sudo apt update
          sudo apt install -y build-essential fakeroot devscripts debhelper golang-any dh-apparmor equivs

      - name: Build .deb package
        run: |
          export VERSION=${{ github.event.release.tag_name }}
          export RELEASE_NOTES="${{ github.event.release.body }}"
          export DEBEMAIL="jimjunior854@gmail.com"
          export DEBFULLNAME="Beingana Jim Junior"
          echo "VERSION_NO_V=$(echo ${{ github.event.release.tag_name }} | cut -c 2-)" >> $GITHUB_ENV
          make deb
        working-directory: ${{ github.workspace }}

      - name: List generated files
        run: |
          ls -la ${{ github.workspace }}/..

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          files: |
            ../conveyor_${{ env.VERSION_NO_V }}-1_${{ matrix.goarch }}.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}


      - name: Publish .deb to open-ug/apt (GitHub Pages APT repo)
        env:
          APT_REPO: open-ug/apt
          DEB_FILENAME: "../conveyor_${{ env.VERSION_NO_V }}-1_${{ matrix.goarch }}.deb"
          GIT_AUTHOR_NAME: "github-actions[bot]"
          GIT_AUTHOR_EMAIL: "actions@github.com"
        run: |
          set -euo pipefail
          echo "Deb file: $DEB_FILENAME"
          if [ ! -f "$DEB_FILENAME" ]; then
            echo "ERROR: deb file not found: $DEB_FILENAME"
            ls -la ..
            exit 1
          fi

          # Clone the apt repo with token so we can push
          git clone https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${APT_REPO}.git apt-repo
          cd apt-repo

          # Checkout the gh-pages branch (create if it doesn't exist)
          if git show-ref --quiet refs/heads/gh-pages; then
            git checkout gh-pages
          else
            git checkout --orphan gh-pages
            # clean working tree for orphan branch
            git rm -rf . >/dev/null 2>&1 || true
            mkdir -p .  # ensure root exists
            git commit --allow-empty -m "Initialize gh-pages branch"
          fi

          # Ensure pool/dists structure exists and clean the package folder
          mkdir -p pool/main/conveyor
          rm -f pool/main/conveyor/*.deb

          mkdir -p dists/stable/main/binary-amd64

          # Copy package into pool
          cp "$GITHUB_WORKSPACE/../conveyor_${{ env.VERSION_NO_V }}-1_${{ matrix.goarch }}.deb" pool/main/conveyor/
          ls -la pool/main/conveyor

          # Generate Packages and compressed files (amd64)
          dpkg-scanpackages pool /dev/null | tee dists/stable/main/binary-amd64/Packages | gzip -9c > dists/stable/main/binary-amd64/Packages.gz

          # Generate a Release file (unsigned)
          apt-ftparchive release dists/stable > dists/stable/Release || true

          # Commit & push to gh-pages
          git config user.name "${GIT_AUTHOR_NAME}"
          git config user.email "${GIT_AUTHOR_EMAIL}"
          git add -A
          git commit -m "Publish conveyor ${VERSION_NO_V} (${matrix.goarch})" || echo "No changes to commit"
          git push origin gh-pages